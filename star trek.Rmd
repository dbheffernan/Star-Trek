---
title: "Untitled"
author: "Dillon Heffernan"
date: "January 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r first, echo=FALSE}
library(tidyverse)
rate <- read_tsv("C:\\Users\\Dillon\\Desktop\\rate.tsv") %>% 
  mutate(parentTconst = tconst)
show_names <- tbl_df(data.frame(series_name=c('Star Trek','Star Trek: The Next Generation',
                                              'Star Trek: Deep Space Nine','Star Trek: Voyager',
                                              'Star Trek: Enterprise','Star Trek: Discovery'),
                               parentTconst=c('tt0060028','tt0092455','tt0106145','tt0112178',
                                              'tt0244365','tt5171438'))) %>%   left_join(rate,by='parentTconst') %>% 
  mutate(series_avg = averageRating) %>%
select(-c('tconst','averageRating','numVotes'))

episodes <- read_tsv("C:\\Users\\Dillon\\Desktop\\episodes.tsv")
shows <- show_names %>% left_join(episodes, by='parentTconst') %>% left_join(rate,by='tconst')
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
library(rvest)
rating_scraper <- function(tconst){
ep_name = '//*[(@id = "main")]//h3//a'
ep_year = '///h3//*[contains(concat( " ", @class, " " ), concat( " ", "nobr", " " ))]'
gen_ratings <- '//*[contains(concat( " ", @class, " " ), concat( " ", "leftAligned", " " ))]'
ep_name = '//*[(@id = "main")]//h3//a'
ep_year = '///h3//*[contains(concat( " ", @class, " " ), concat( " ", "nobr", " " ))]'
gen_ratings <- '//*[contains(concat( " ", @class, " " ), concat( " ", "leftAligned", " " ))]'
demo_ratings <- '//table[(((count(preceding-sibling::*) + 1) = 14) and parent::*)]//*[contains(concat( " ", @class, " " ), concat( " ", "bigcell", " " ))]'
demo_votes<- '//table[(((count(preceding-sibling::*) + 1) = 14) and parent::*)]//*[contains(concat( " ", @class, " " ), concat( " ", "smallcell", " " ))]'
url <- read_html(str_c("https://www.imdb.com/title/",tconst,"/ratings?ref_=tt_ov_rt"))
name <- url %>% html_nodes(xpath = ep_name) %>% html_text()
year <- url %>% html_nodes(xpath = ep_year) %>% html_text() %>% str_extract('\\d\\d\\d\\d')%>%as.numeric()
demos <- url %>% html_nodes(xpath = demo_ratings) %>%
  html_text() %>% as.numeric()
demo <- tibble(men = c(demos[8],demos[9],demos[10]),
               feemales = c(demos[13],demos[14],demos[15]))

g_ratings <- url %>% html_nodes(xpath = gen_ratings) %>% html_text()
#g_ratings <- ratings[2:11] %>% as.numeric() %>% tibble()

ratings <- bind_cols(tconst = tconst,name=name,year=year,
                     mz=demos[8],my=demos[9],mx=demos[10],
                     fz=demos[13],fy=demos[14],fx=demos[15],
                     a10 = g_ratings[2],
                     a9 = g_ratings[3],
                     a8 = g_ratings[4],
                     a7 = g_ratings[5],
                     a6 = g_ratings[6],
                     a5 = g_ratings[7],
                     a4 = g_ratings[8],
                     a3 = g_ratings[9],
                     a2 = g_ratings[10],
                     a1 = g_ratings[11])
return (ratings)
}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
# tbg <- rating_scraper('tt0708797')
# sorry_IMDB <- function(x,y,tbg){
# for(ep in shows$tconst[x:y]){
#   week <- rating_scraper(ep)
#   tbg <- tbg %>% bind_rows(week)
# }
  
#  return(tbg)}
#showss <- tbg %>% distinct() %>% right_join(shows,by='tconst')
#showss <- showss %>% mutate(demo_adj = mz*.235+my*.173+mx*.1484+fz*.184+fy*.1364+fx*.1166)
#tst$mz*.235+tst$my*.173+tst$mx*.1484+tst$fz*.184+tst$fy*.1364+tst$fx*.1166
tbg <- read_csv("C:\\Users\\Dillon\\Desktop\\scrape.csv") %>%
  select(-c('series_name')) %>%
  left_join(show_names,by='parentTconst') %>%
  mutate(demo_adj = mz/6+my/6+mx/6+fz/6+fy/6+fx/6)%>%
  select(c('tconst','name','year','series_name','seasonNumber','episodeNumber','averageRating','numVotes','demo_adj','series_avg')) %>% mutate(demo_adj = round((demo_adj),1))
tos <- tbg %>% filter(series_name == 'Star Trek')
tng <- tbg %>% filter(series_name == 'Star Trek: The Next Generation')
ds9 <- tbg %>% filter(series_name == 'Star Trek: Deep Space Nine')
voy <- tbg %>% filter(series_name == 'Star Trek: Voyager')
ent <- tbg %>% filter(series_name == 'Star Trek: Enterprise')
dis <- tbg %>% filter(series_name == 'Star Trek: Discovery')
dem <- tbg %>% group_by(series_name) %>%
  summarise(meany = mean(averageRating),adjmean = mean(demo_adj), series = mean(series_avg))
```

```{r}
crew_scraper <- function(tconst,original){
cp2 <- '//td'
url <- read_html(str_c("https://www.imdb.com/title/",tconst,"/fullcredits/?ref_=tt_ov_st_sm"))
tabl <- url %>% html_table(fill = TRUE)
direct <- tabl[[1]][1] %>% str_c()
return(direct)}
```

